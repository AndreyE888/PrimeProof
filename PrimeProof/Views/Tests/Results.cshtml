@model PrimeProof.Models.ViewModels.TestComparisonViewModel
@{
    ViewData["Title"] = "PrimeProof - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è";
}

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            </h2>
            <a href="@Url.Action("Index")" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>–ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            </a>
        </div>

        <!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>–ü—Ä–æ–≤–µ—Ä—è–µ–º–æ–µ —á–∏—Å–ª–æ: <strong class="text-primary">@Model.Number</strong></h5>
                        <p class="text-muted mb-0">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤: @Model.Results.Count</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <h5>–û–±—â–µ–µ –≤—Ä–µ–º—è: <span class="badge bg-info fs-6">@Model.FormattedTotalTime</span></h5>
                        @if (Model.Results.All(r => r.IsPrime))
                        {
                            <span class="badge bg-success fs-6">–í–°–ï –¢–ï–°–¢–´: –ü–†–û–°–¢–û–ï</span>
                        }
                        else if (Model.Results.All(r => !r.IsPrime))
                        {
                            <span class="badge bg-danger fs-6">–í–°–ï –¢–ï–°–¢–´: –°–û–°–¢–ê–í–ù–û–ï</span>
                        }
                        else
                        {
                            <span class="badge bg-warning fs-6">–†–ï–ó–£–õ–¨–¢–ê–¢–´ –†–ê–ó–û–®–õ–ò–°–¨</span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div class="row mb-4">
            @foreach (var result in Model.Results)
            {
                <div class="col-md-6 col-lg-3 mb-3">
                    <div class="card h-100 @(result.IsPrime ? "border-success" : "border-danger")">
                        <div class="card-header @(result.IsPrime ? "bg-success" : "bg-danger") text-white">
                            <h6 class="card-title mb-0">@result.TestName</h6>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <span class="badge @result.ResultClass fs-6">@result.ResultText</span>
                            </div>
                            <div class="small">
                                <div class="d-flex justify-content-between">
                                    <span>–í—Ä–µ–º—è:</span>
                                    <strong>@result.FormattedExecutionTime</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:</span>
                                    <strong>@result.FormattedProbability</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>–ò—Ç–µ—Ä–∞—Ü–∏–∏:</span>
                                    <strong>@result.Iterations</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–µ—Å—Ç—É -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list-alt me-2"></i>–î–µ—Ç–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="accordion" id="testAccordion">
                    @for (int i = 0; i < Model.Results.Count; i++)
                    {
                        var result = Model.Results[i];
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading@(i)">
                                <button class="accordion-button @(i == 0 ? "" : "collapsed")" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapse@(i)"
                                        aria-expanded="@(i == 0 ? "true" : "false")" aria-controls="collapse@(i)">
                                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                        <span>
                                            <span class="badge @result.ResultClass me-2">@result.ResultText</span>
                                            @result.TestName
                                        </span>
                                        <span class="text-muted small">@result.FormattedExecutionTime</span>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse@(i)" class="accordion-collapse collapse @(i == 0 ? "show" : "")"
                                 aria-labelledby="heading@(i)" data-bs-parent="#testAccordion">
                                <div class="accordion-body">
                                    <!-- –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∞ -->
                                    <div class="alert @(result.IsPrime ? "alert-success" : "alert-danger") mb-3">
                                        <h6 class="alert-heading">
                                            <i class="fas @(result.IsPrime ? "fa-check-circle" : "fa-times-circle") me-2"></i>
                                            @result.Message
                                        </h6>
                                        @if (!string.IsNullOrEmpty(result.Message))
                                        {
                                            <p class="mb-0 small">@result.Message</p>
                                        }
                                    </div>

                                    <!-- –î–µ—Ç–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
                                    <h6 class="mb-3">
                                        <i class="fas fa-info-circle me-2"></i>–î–µ—Ç–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
                                    </h6>
                                    <div class="log-container bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                                        @if (result.Details != null && result.Details.Any())
                                        {
                                            foreach (var detail in result.Details)
                                            {
                                                <div class="log-entry mb-2 small">
                                                    @if (detail.Contains("‚úì") || detail.Contains("–£—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ"))
                                                    {
                                                        <span class="text-success">‚úì @detail</span>
                                                    }
                                                    else if (detail.Contains("‚ùå") || detail.Contains("–ù–∞–π–¥–µ–Ω–æ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ") || detail.Contains("–°–û–°–¢–ê–í–ù–û–ï"))
                                                    {
                                                        <span class="text-danger">‚ùå @detail</span>
                                                    }
                                                    else if (detail.Contains("‚ö†Ô∏è") || detail.Contains("–í–ù–ò–ú–ê–ù–ò–ï") || detail.Contains("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ"))
                                                    {
                                                        <span class="text-warning">‚ö†Ô∏è @detail</span>
                                                    }
                                                    else if (detail.Contains("üîç") || detail.Contains("–ù–∞–π–¥–µ–Ω"))
                                                    {
                                                        <span class="text-info">üîç @detail</span>
                                                    }
                                                    else if (detail.Contains("---"))
                                                    {
                                                        <hr class="my-2">
                                                        <strong class="text-primary">@detail</strong>
                                                    }
                                                    else
                                                    {
                                                        <span>@detail</span>
                                                    }
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="text-muted">–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</div>
                                        }
                                    </div>

                                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                                    <div class="row mt-3">
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-body text-center py-2">
                                                    <h6 class="card-title text-muted mb-1">–í—Ä–µ–º—è</h6>
                                                    <p class="card-text fw-bold">@result.FormattedExecutionTime</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-body text-center py-2">
                                                    <h6 class="card-title text-muted mb-1">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å</h6>
                                                    <p class="card-text fw-bold">@result.FormattedProbability</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-body text-center py-2">
                                                    <h6 class="card-title text-muted mb-1">–ò—Ç–µ—Ä–∞—Ü–∏–∏</h6>
                                                    <p class="card-text fw-bold">@result.Iterations</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
            <a href="@Url.Action("Index")" class="btn btn-primary btn-lg me-md-2">
                <i class="fas fa-redo me-2"></i>–ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            </a>
            <button id="exportBtn" class="btn btn-outline-success btn-lg">
                <i class="fas fa-download me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            $('#exportBtn').click(function() {
                const results = @Html.Raw(Json.Serialize(Model));
                const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `primality_test_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–≤ –µ—Å–ª–∏ —Ç–µ—Å—Ç–æ–≤ –º–∞–ª–æ
            if (@Model.Results.Count <= 2) {
                $('.accordion-collapse').addClass('show');
            }

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
            const primeResults = @Html.Raw(Json.Serialize(Model.Results.Select(r => r.IsPrime)));
            if (primeResults.some(r => r) && primeResults.some(r => !r)) {
                $('.card-header.bg-success, .card-header.bg-danger').addClass('bg-warning');
                // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                $('.card:first').before(`
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ —Ä–∞–∑–æ—à–ª–∏—Å—å. –≠—Ç–æ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –æ—Å–æ–±—ã–µ —Å–ª—É—á–∞–∏ (—á–∏—Å–ª–∞ –ö–∞—Ä–º–∞–π–∫–ª–∞) –∏–ª–∏ –æ—à–∏–±–∫–∏ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `);
            }
        });
    </script>

    <style>
        .log-container {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.3;
        }

        .log-entry {
            border-left: 3px solid #dee2e6;
            padding-left: 10px;
            margin-bottom: 5px;
        }

        .accordion-button:not(.collapsed) {
            background-color: #f8f9fa;
            color: #000;
        }

        .card {
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }
    </style>
}